name: ğŸ³ Validate Docker Compose

on:
  push:
    branches: [ master ]
    paths:
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/validate-docker-compose.yml'
  pull_request:
    branches: [ feature/*, bugfix/* ]
    paths:
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/validate-docker-compose.yml'
  workflow_dispatch:

env:
  COMPOSE_FILE: docker-compose.yml

jobs:
  validate-compose:
    name: ğŸ” Validate Docker Compose Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”§ Set up Docker Compose
      run: |
        # VÃ©rifier la version de Docker Compose
        docker compose version
        echo "âœ… Docker Compose version check passed"
        
    - name: ğŸ“‹ Create test environment file
      run: |
        # CrÃ©er un fichier .env pour les tests
        cat << 'EOF' > .env
        # Test environment variables
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF
        echo "âœ… Test environment file created"

    - name: ğŸ” Validate Docker Compose syntax
      run: |
        echo "ğŸ” Validating Docker Compose syntax..."
        if docker compose config --quiet; then
          echo "âœ… Docker Compose syntax is valid"
        else
          echo "âŒ Docker Compose syntax validation failed"
          exit 1
        fi

    - name: ğŸ“Š Analyze Docker Compose configuration
      run: |
        echo "ğŸ“Š Analyzing Docker Compose configuration..."
        
        # Afficher la configuration parsÃ©e (pour debug)
        echo "--- Configuration parsed ---"
        docker compose config
        
        # VÃ©rifications spÃ©cifiques
        echo "--- Configuration Analysis ---"
        
        # VÃ©rifier la prÃ©sence des services essentiels
        if docker compose config --services | grep -q "n8n"; then
          echo "âœ… n8n service found"
        else
          echo "âŒ n8n service missing"
          exit 1
        fi
        
        if docker compose config --services | grep -q "postgres"; then
          echo "âœ… postgres service found"
        else
          echo "âŒ postgres service missing"
          exit 1
        fi
        
        # VÃ©rifier que les volumes sont dÃ©finis
        if docker compose config --volumes | grep -q "n8n_storage"; then
          echo "âœ… n8n_storage volume defined"
        else
          echo "âŒ n8n_storage volume missing"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence du rÃ©seau
        if docker compose config | grep -q "networks:"; then
          echo "âœ… Networks configuration found"
        else
          echo "âš ï¸  No custom networks defined"
        fi

    - name: ğŸ§ª Test Docker Compose build
      run: |
        echo "ğŸ§ª Testing Docker Compose build process..."
        
        # Test du build sans dÃ©marrer les services
        if docker compose build --no-cache n8n; then
          echo "âœ… n8n service build successful"
        else
          echo "âŒ n8n service build failed"
          exit 1
        fi

    - name: ğŸ”’ Security scan of Docker Compose
      run: |
        echo "ğŸ”’ Performing security analysis..."
        
        # VÃ©rifications de sÃ©curitÃ© basiques
        echo "--- Security Analysis ---"
        
        # VÃ©rifier qu'on n'utilise pas de mots de passe en dur
        if grep -q "password.*:" docker-compose.yml && ! grep -q "\${" docker-compose.yml; then
          echo "âš ï¸  Potential hardcoded passwords found"
        else
          echo "âœ… No hardcoded passwords detected"
        fi
        
        # VÃ©rifier l'utilisation de variables d'environnement
        if grep -q "\${" docker-compose.yml; then
          echo "âœ… Environment variables are used"
        else
          echo "âš ï¸  Consider using environment variables for configuration"
        fi
        
        # VÃ©rifier les ports exposÃ©s
        exposed_ports=$(docker compose config | grep -E "^\s+- \"[0-9]+:" | wc -l)
        echo "ğŸ“Š Number of exposed ports: $exposed_ports"
        
        if [ "$exposed_ports" -gt 5 ]; then
          echo "âš ï¸  Many ports exposed, review for security"
        else
          echo "âœ… Reasonable number of exposed ports"
        fi

    - name: ğŸš€ Test services startup (dry-run)
      run: |
        echo "ğŸš€ Testing services startup..."
        
        # Test de dÃ©marrage avec validation uniquement
        if docker compose up --dry-run; then
          echo "âœ… Services startup validation passed"
        else
          echo "âŒ Services startup validation failed"
          exit 1
        fi

    - name: ğŸ“‹ Generate validation report
      if: always()
      run: |
        echo "ğŸ“‹ Generating validation report..."
        
        # **MEASUREMENT**: Collecter les mÃ©triques
        SERVICES_COUNT=$(docker compose config --services | wc -l)
        VOLUMES_COUNT=$(docker compose config --volumes | wc -l)
        NETWORKS_COUNT=$(docker compose config | grep -c "networks:" || echo "0")
        VALIDATION_DATE=$(date -Iseconds)
        
        # **SHARING**: GÃ©nÃ©rer le rapport avec les vraies valeurs
        cat << EOF > validation-report.md
        # ğŸ³ Docker Compose Validation Report
        
        ## ğŸ“Š Summary
        - **File**: \`docker-compose.yml\`
        - **Validation Date**: ${VALIDATION_DATE}
        - **Commit**: ${{ github.sha }}
        - **Branch**: ${{ github.ref_name }}
        - **Workflow Run**: #${{ github.run_number }}
        
        ## âœ… Validations Performed
        - [x] Syntax validation
        - [x] Service configuration analysis
        - [x] Build process testing
        - [x] Security scanning
        - [x] Startup validation
        
        ## ğŸ“ˆ Metrics
        - **Services**: ${SERVICES_COUNT}
        - **Volumes**: ${VOLUMES_COUNT}
        - **Networks**: ${NETWORKS_COUNT}
        - **Exposed Ports**: $(docker compose config | grep -E "^\s+- \"[0-9]+:" | wc -l)
        
        ## ğŸ”§ Configuration Details
        ### Services detected:
        $(docker compose config --services | sed 's/^/- /')
        
        ### Volumes detected:
        $(docker compose config --volumes | sed 's/^/- /' || echo "- No named volumes")
        
        ## ğŸ”’ Security Analysis
        - Environment variables usage: $(grep -c "\${" docker-compose.yml || echo "0") occurrences
        - Hardcoded passwords check: $(if grep -q "password.*:" docker-compose.yml && ! grep -q "\${" docker-compose.yml; then echo "âš ï¸ Potential issues found"; else echo "âœ… No issues detected"; fi)
        
        ## ï¿½ Performance Metrics
        - Build validation: $(if docker compose config --quiet 2>/dev/null; then echo "âœ… Passed"; else echo "âŒ Failed"; fi)
        - Configuration size: $(wc -l < docker-compose.yml) lines
        
        ---
        *Report generated by GitHub Actions on ${VALIDATION_DATE}*
        EOF
        
        echo "âœ… Validation report generated with metrics:"
        echo "  - Services: ${SERVICES_COUNT}"
        echo "  - Volumes: ${VOLUMES_COUNT}" 
        echo "  - Networks: ${NETWORKS_COUNT}"

    - name: ğŸ“¤ Upload validation artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-compose-validation-${{ github.run_number }}
        path: |
          validation-report.md
          community-nodes-report.txt
          docker-compose.yml
          .env
        retention-days: 30

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up test artifacts..."
        
        # Nettoyer les images de test
        docker compose down --volumes --remove-orphans 2>/dev/null || true
        docker system prune -f --volumes 2>/dev/null || true
        
        echo "âœ… Cleanup completed"

  validate-community-nodes:
    name: ğŸ§© Validate Community Nodes Installation
    runs-on: ubuntu-latest
    needs: validate-compose
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Create test environment
      run: |
        cat << 'EOF' > .env
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF

    - name: ğŸ§© Test community nodes installation
      run: |
        echo "ğŸ§© Testing community nodes installation..."
        
        # Builder l'image n8n avec les community nodes
        docker compose build n8n
        
        # **MEASUREMENT**: Obtenir le nom de l'image buildÃ©e
        IMAGE_NAME=$(docker compose config --format json | jq -r '.services.n8n.build.dockerfile_inline' | head -1 | grep -o 'FROM.*' | cut -d' ' -f2 || echo "n8n:latest")
        PROJECT_NAME=$(basename $PWD | tr '[:upper:]' '[:lower:]')
        
        echo "ğŸ” Checking installed community nodes..."
        echo "Using image: ${PROJECT_NAME}_n8n"
        
        # **AUTOMATION**: Tester les community nodes avec retry logic
        test_node_installation() {
          local node_name=$1
          local max_attempts=3
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Testing $node_name (attempt $attempt/$max_attempts)..."
            if docker run --rm "${PROJECT_NAME}_n8n" npm list -g "$node_name" 2>/dev/null; then
              echo "âœ… $node_name is installed"
              return 0
            else
              echo "âš ï¸ Attempt $attempt failed for $node_name"
              attempt=$((attempt + 1))
              sleep 2
            fi
          done
          
          echo "âŒ $node_name installation verification failed after $max_attempts attempts"
          return 1
        }
        
        # Tester chaque community node
        test_node_installation "n8n-nodes-imap-ai" || exit 1
        test_node_installation "n8n-nodes-mcp" || exit 1
        
        echo "âœ… All community nodes are properly installed"
        
        # **MEASUREMENT**: GÃ©nÃ©rer un rapport des nodes installÃ©s
        echo "ğŸ“Š Generating community nodes report..."
        docker run --rm "${PROJECT_NAME}_n8n" npm list -g --depth=0 | grep n8n-nodes > community-nodes-report.txt || echo "No community nodes pattern found" > community-nodes-report.txt
        cat community-nodes-report.txt

  performance-test:
    name: ğŸš€ Performance & Resource Testing
    runs-on: ubuntu-latest
    needs: validate-compose
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Create test environment
      run: |
        cat << 'EOF' > .env
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF

    - name: â±ï¸ Measure build time
      run: |
        echo "â±ï¸ Measuring build performance..."
        
        # **MEASUREMENT**: Mesurer prÃ©cisÃ©ment le temps de build
        start_time=$(date +%s)
        echo "Build started at: $(date -Iseconds)"
        
        docker compose build
        
        end_time=$(date +%s)
        build_duration=$((end_time - start_time))
        
        echo "Build completed at: $(date -Iseconds)"
        echo "ğŸ“Š Build duration: ${build_duration} seconds"
        
        # **AUTOMATION**: CrÃ©er un rapport de performance
        cat << EOF > performance-report.md
        # ğŸš€ Performance Report
        
        ## Build Metrics
        - **Build Duration**: ${build_duration} seconds
        - **Build Status**: $(if [ $build_duration -gt 300 ]; then echo "âš ï¸ Slow (>5min)"; else echo "âœ… Acceptable"; fi)
        - **Start Time**: $(date -d "@$start_time" -Iseconds)
        - **End Time**: $(date -d "@$end_time" -Iseconds)
        
        ## Recommendations
        $(if [ $build_duration -gt 300 ]; then 
          echo "- Consider optimizing Dockerfile layers"
          echo "- Review community nodes installation process"
          echo "- Add build caching strategies"
        else
          echo "- Build performance is acceptable"
          echo "- No immediate optimizations needed"
        fi)
        EOF
        
        # Alerter si le build prend trop de temps
        if [ $build_duration -gt 300 ]; then
          echo "âš ï¸ Build took longer than 5 minutes ($build_duration seconds)"
          echo "Consider optimizing the build process"
        else
          echo "âœ… Build completed in reasonable time"
        fi
        
        # Sauvegarder la mÃ©trique pour les autres jobs
        echo "BUILD_DURATION=${build_duration}" >> $GITHUB_ENV

    - name: ğŸ“ˆ Analyze resource usage
      run: |
        echo "ğŸ“ˆ Analyzing resource requirements..."

        # **MEASUREMENT**: Analyser les requirements de ressources
        if grep -q "deploy:" docker-compose.yml; then
          echo "âœ… Resource limits defined in compose file"
          grep -A 10 "deploy:" docker-compose.yml
        else
          echo "âš ï¸  No resource limits defined - consider adding them for production"
        fi
        
        # **MEASUREMENT**: VÃ©rifier la taille des images avec mÃ©triques dÃ©taillÃ©es
        echo "ğŸ“Š Analyzing image sizes..."
        docker compose pull
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.VirtualSize}}" | head -1
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.VirtualSize}}" | grep -E "(n8n|postgres|ollama|qdrant)" || echo "No matching images found yet"
        
        # **AUTOMATION**: GÃ©nÃ©rer un rapport de ressources
        cat << EOF > resource-report.md
        # ğŸ“ˆ Resource Analysis Report
        
        ## Resource Limits
        $(if grep -q "deploy:" docker-compose.yml; then 
          echo "âœ… Resource limits are defined"
          grep -A 10 "deploy:" docker-compose.yml | sed 's/^/    /'
        else
          echo "âš ï¸ No resource limits defined"
          echo ""
          echo "### Recommendations:"
          echo "- Add memory limits for production"
          echo "- Consider CPU reservations"
          echo "- Add restart policies"
        fi)
        
        ## Image Sizes
        \`\`\`
        $(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "(Repository|n8n|postgres|ollama|qdrant)" || echo "Images not yet available")
        \`\`\`
        
        ## Performance Impact
        - Build Duration: ${BUILD_DURATION:-"Not measured"} seconds
        - Resource Profile: $(if grep -q "deploy:" docker-compose.yml; then echo "Optimized"; else echo "Default"; fi)
        EOF
        
        echo "âœ… Resource analysis completed"
    
    - name: ğŸ“¤ Upload performance artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports-${{ github.run_number }}
        path: |
          performance-report.md
          resource-report.md
        retention-days: 30

  notification:
    name: ğŸ“¢ Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-compose, validate-community-nodes, performance-test]
    if: always()
    
    steps:
    - name: ğŸ“¢ Create validation summary
      run: |
        echo "ğŸ“¢ Docker Compose Validation Summary"
        echo "======================================"
        echo "ğŸ” Syntax validation: ${{ needs.validate-compose.result }}"
        echo "ğŸ§© Community nodes: ${{ needs.validate-community-nodes.result }}"
        echo "ğŸš€ Performance test: ${{ needs.performance-test.result }}"
        echo "======================================"
        
        if [[ "${{ needs.validate-compose.result }}" == "success" && 
              "${{ needs.validate-community-nodes.result }}" == "success" && 
              "${{ needs.performance-test.result }}" == "success" ]]; then
          echo "âœ… All validations passed successfully!"
          echo "ğŸš€ Docker Compose configuration is ready for deployment"
        else
          echo "âŒ Some validations failed"
          echo "ğŸ”§ Please review the failed jobs and fix the issues"
          exit 1
        fi
