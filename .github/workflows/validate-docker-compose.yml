name: ğŸ³ Validate Docker Compose

on:
  push:
    branches: [ master ]
    paths:
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/validate-docker-compose.yml'
  pull_request:
    branches: [ feature/*, bugfix/* ]
    paths:
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/validate-docker-compose.yml'
  workflow_dispatch:

env:
  COMPOSE_FILE: docker-compose.yml

jobs:
  validate-compose:
    name: ğŸ” Validate Docker Compose Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”§ Set up Docker Compose
      run: |
        # VÃ©rifier la version de Docker Compose
        docker compose version
        echo "âœ… Docker Compose version check passed"
        
    - name: ğŸ“‹ Create test environment file
      run: |
        # CrÃ©er un fichier .env pour les tests
        cat << 'EOF' > .env
        # Test environment variables
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF
        echo "âœ… Test environment file created"

    - name: ğŸ” Validate Docker Compose syntax
      run: |
        echo "ğŸ” Validating Docker Compose syntax..."
        if docker compose config --quiet; then
          echo "âœ… Docker Compose syntax is valid"
        else
          echo "âŒ Docker Compose syntax validation failed"
          exit 1
        fi

    - name: ğŸ“Š Analyze Docker Compose configuration
      run: |
        echo "ğŸ“Š Analyzing Docker Compose configuration..."
        
        # Afficher la configuration parsÃ©e (pour debug)
        echo "--- Configuration parsed ---"
        docker compose config
        
        # VÃ©rifications spÃ©cifiques
        echo "--- Configuration Analysis ---"
        
        # VÃ©rifier la prÃ©sence des services essentiels
        if docker compose config --services | grep -q "n8n"; then
          echo "âœ… n8n service found"
        else
          echo "âŒ n8n service missing"
          exit 1
        fi
        
        if docker compose config --services | grep -q "postgres"; then
          echo "âœ… postgres service found"
        else
          echo "âŒ postgres service missing"
          exit 1
        fi
        
        # VÃ©rifier que les volumes sont dÃ©finis
        if docker compose config --volumes | grep -q "n8n_storage"; then
          echo "âœ… n8n_storage volume defined"
        else
          echo "âŒ n8n_storage volume missing"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence du rÃ©seau
        if docker compose config | grep -q "networks:"; then
          echo "âœ… Networks configuration found"
        else
          echo "âš ï¸  No custom networks defined"
        fi

    - name: ğŸ§ª Test Docker Compose build
      run: |
        echo "ğŸ§ª Testing Docker Compose build process..."
        
        # Test du build sans dÃ©marrer les services
        if docker compose build --no-cache n8n; then
          echo "âœ… n8n service build successful"
        else
          echo "âŒ n8n service build failed"
          exit 1
        fi

    - name: ğŸ”’ Security scan of Docker Compose
      run: |
        echo "ğŸ”’ Performing security analysis..."
        
        # VÃ©rifications de sÃ©curitÃ© basiques
        echo "--- Security Analysis ---"
        
        # VÃ©rifier qu'on n'utilise pas de mots de passe en dur
        if grep -q "password.*:" docker-compose.yml && ! grep -q "\${" docker-compose.yml; then
          echo "âš ï¸  Potential hardcoded passwords found"
        else
          echo "âœ… No hardcoded passwords detected"
        fi
        
        # VÃ©rifier l'utilisation de variables d'environnement
        if grep -q "\${" docker-compose.yml; then
          echo "âœ… Environment variables are used"
        else
          echo "âš ï¸  Consider using environment variables for configuration"
        fi
        
        # VÃ©rifier les ports exposÃ©s
        exposed_ports=$(docker compose config | grep -E "^\s+- \"[0-9]+:" | wc -l)
        echo "ğŸ“Š Number of exposed ports: $exposed_ports"
        
        if [ "$exposed_ports" -gt 5 ]; then
          echo "âš ï¸  Many ports exposed, review for security"
        else
          echo "âœ… Reasonable number of exposed ports"
        fi

    - name: ğŸš€ Test services startup (dry-run)
      run: |
        echo "ğŸš€ Testing services startup..."
        
        # Test de dÃ©marrage avec validation uniquement
        if docker compose up --dry-run; then
          echo "âœ… Services startup validation passed"
        else
          echo "âŒ Services startup validation failed"
          exit 1
        fi

    - name: ğŸ“‹ Generate validation report
      if: always()
      run: |
        echo "ğŸ“‹ Generating validation report..."
        
        cat << 'EOF' > validation-report.md
        # ğŸ³ Docker Compose Validation Report
        
        ## ğŸ“Š Summary
        - **File**: `docker-compose.yml`
        - **Validation Date**: $(date -Iseconds)
        - **Commit**: ${{ github.sha }}
        - **Branch**: ${{ github.ref_name }}
        
        ## âœ… Validations Performed
        - [x] Syntax validation
        - [x] Service configuration analysis
        - [x] Build process testing
        - [x] Security scanning
        - [x] Startup validation
        
        ## ğŸ“ˆ Metrics
        - **Services**: $(docker compose config --services | wc -l)
        - **Volumes**: $(docker compose config --volumes | wc -l)
        - **Networks**: $(docker compose config | grep -c "networks:" || echo "0")
        
        ## ğŸ”§ Configuration Details
        $(docker compose config --services | sed 's/^/- /')
        
        EOF
        
        echo "âœ… Validation report generated"

    - name: ğŸ“¤ Upload validation artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-compose-validation-${{ github.run_number }}
        path: |
          validation-report.md
          docker-compose.yml
          .env
        retention-days: 30

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up test artifacts..."
        
        # Nettoyer les images de test
        docker compose down --volumes --remove-orphans 2>/dev/null || true
        docker system prune -f --volumes 2>/dev/null || true
        
        echo "âœ… Cleanup completed"

  validate-community-nodes:
    name: ğŸ§© Validate Community Nodes Installation
    runs-on: ubuntu-latest
    needs: validate-compose
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Create test environment
      run: |
        cat << 'EOF' > .env
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF

    - name: ğŸ§© Test community nodes installation
      run: |
        echo "ğŸ§© Testing community nodes installation..."
        
        # Builder l'image n8n avec les community nodes
        docker compose build n8n
        
        # CrÃ©er un conteneur temporaire pour tester l'installation
        container_id=$(docker create $(docker compose config | grep "image:" | grep n8n | head -1 | awk '{print $2}') /bin/sh)
        
        # VÃ©rifier l'installation des community nodes
        echo "ğŸ” Checking installed community nodes..."
        
        if docker run --rm $(docker compose config | grep "image:" | grep n8n | head -1 | awk '{print $2}') npm list -g n8n-nodes-imap-ai; then
          echo "âœ… n8n-nodes-imap-ai is installed"
        else
          echo "âŒ n8n-nodes-imap-ai installation failed"
          exit 1
        fi
        
        if docker run --rm $(docker compose config | grep "image:" | grep n8n | head -1 | awk '{print $2}') npm list -g n8n-nodes-mcp; then
          echo "âœ… n8n-nodes-mcp is installed"
        else
          echo "âŒ n8n-nodes-mcp installation failed"
          exit 1
        fi
        
        echo "âœ… All community nodes are properly installed"

  performance-test:
    name: ğŸš€ Performance & Resource Testing
    runs-on: ubuntu-latest
    needs: validate-compose
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ“‹ Create test environment
      run: |
        cat << 'EOF' > .env
        POSTGRES_DB=n8n_test
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=test_password_123
        POSTGRES_NON_ROOT_USER=n8n
        POSTGRES_NON_ROOT_PASSWORD=test_n8n_password_123
        N8N_BASIC_AUTH_USER=admin
        N8N_BASIC_AUTH_PASSWORD=test_admin_password_123
        N8N_ENCRYPTION_KEY=test_encryption_key_1234567890abcdef
        GENERIC_TIMEZONE=Europe/Paris
        EOF

    - name: â±ï¸ Measure build time
      run: |
        echo "â±ï¸ Measuring build performance..."
        
        start_time=$(date +%s)
        docker compose build
        end_time=$(date +%s)
        
        build_duration=$((end_time - start_time))
        echo "ğŸ“Š Build duration: ${build_duration} seconds"
        
        # Alerter si le build prend trop de temps
        if [ $build_duration -gt 300 ]; then
          echo "âš ï¸  Build took longer than 5 minutes ($build_duration seconds)"
        else
          echo "âœ… Build completed in reasonable time"
        fi

    - name: ğŸ“ˆ Analyze resource usage
      run: |
        echo "ğŸ“ˆ Analyzing resource requirements..."
        
        # Analyser les requirements de ressources dans le compose file
        if grep -q "deploy:" docker-compose.yml; then
          echo "âœ… Resource limits defined in compose file"
          grep -A 10 "deploy:" docker-compose.yml
        else
          echo "âš ï¸  No resource limits defined - consider adding them for production"
        fi
        
        # VÃ©rifier la taille des images
        echo "ğŸ“Š Image sizes:"
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "(n8n|postgres|ollama|qdrant)"

  notification:
    name: ğŸ“¢ Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-compose, validate-community-nodes, performance-test]
    if: always()
    
    steps:
    - name: ğŸ“¢ Create validation summary
      run: |
        echo "ğŸ“¢ Docker Compose Validation Summary"
        echo "======================================"
        echo "ğŸ” Syntax validation: ${{ needs.validate-compose.result }}"
        echo "ğŸ§© Community nodes: ${{ needs.validate-community-nodes.result }}"
        echo "ğŸš€ Performance test: ${{ needs.performance-test.result }}"
        echo "======================================"
        
        if [[ "${{ needs.validate-compose.result }}" == "success" && 
              "${{ needs.validate-community-nodes.result }}" == "success" && 
              "${{ needs.performance-test.result }}" == "success" ]]; then
          echo "âœ… All validations passed successfully!"
          echo "ğŸš€ Docker Compose configuration is ready for deployment"
        else
          echo "âŒ Some validations failed"
          echo "ğŸ”§ Please review the failed jobs and fix the issues"
          exit 1
        fi
